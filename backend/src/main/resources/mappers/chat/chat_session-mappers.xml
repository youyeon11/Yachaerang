<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.yachaerang.backend.api.chat.repository.ChatSessionMapper">

    <resultMap id="ChatSessionResultMap"
               type="com.yachaerang.backend.api.chat.entity.ChatSession">
        <id property="chatSessionId" column="chat_session_id"/>
        <result property="senderId" column="sender_id"/>
        <result property="startedAt" column="started_at"/>
        <result property="sessionStatus" column="session_status" javaType="com.yachaerang.backend.api.common.SessionStatus"
        typeHandler="com.yachaerang.backend.global.util.SessionStatusHandler"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>
    <!-- save -->
    <insert id="save"
            parameterType="com.yachaerang.backend.api.chat.entity.ChatSession"
            useGeneratedKeys="true"
            keyProperty="chatSessionId"
            keyColumn="chat_session_id">
        INSERT INTO chat_session (
            sender_id,
            started_at,
            session_status,
            created_at,
            updated_at
        ) VALUES (
                     #{senederId},
                     #{startedAt},
                     #{sessionStatus},
                     NOW(),
                     NOW()
                 )
    </insert>

    <!-- SELECT by ID -->
    <select id="findById"
            parameterType="long"
            resultMap="ChatSessionResultMap">
        SELECT
            cs.chat_session_id,
            cs.sender_id,
            cs.started_at,
            cs.session_status,
            cs.created_at,
            cs.updated_at
        FROM chat_session cs
        WHERE cs.chat_session_id = #{id}
    </select>

    <!-- SELECT all by senderId -->
    <select id="findAllByMemberId"
            parameterType="long"
            resultMap="ChatSessionResultMap">
        SELECT
            cs.chat_session_id,
            cs.sender_id,
            cs.started_at,
            cs.session_status,
            cs.created_at,
            cs.updated_at
        FROM chat_session cs
        WHERE cs.sender_id = #{memberId}
        ORDER BY cs.created_at DESC
    </select>

    <!-- SELECT active sessions by senderId -->
    <select id="findActiveSessionsByMemberId"
            parameterType="long"
            resultMap="ChatSessionResultMap">
        SELECT
            cs.chat_session_id,
            cs.sender_id,
            cs.started_at,
            cs.session_status,
            cs.created_at,
            cs.updated_at
        FROM chat_session cs
        WHERE cs.sender_id = #{memberId}
        AND cs.session_status = 'ACTIVE'
        ORDER BY cs.created_at DESC
    </select>

    <!-- UPDATE status -->
    <update id="updateStatus"
            parameterType="com.yachaerang.backend.api.chat.entity.ChatSession">
        UPDATE chat_session
        SET session_status = #{sessionStatus},
            updated_at      = NOW()
        WHERE chat_session_id = #{chatSessionId}
    </update>

</mapper>
