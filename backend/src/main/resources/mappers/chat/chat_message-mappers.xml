<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.yachaerang.backend.api.chat.repository.ChatMessageMapper">

    <!--
        JOIN 시(ChatSessionMapper.findByIdWithMessages)용 ResultMap
        createdAt, updatedAt 컬럼만 msg_ prefix 를 사용 (JOIN 쿼리와 맞춰야 함)
    -->
    <resultMap id="ChatMessageResultMap"
               type="com.yachaerang.backend.api.chat.entity.ChatMessage">
        <!-- PK -->
        <id property="id" column="chat_message_id"/>

        <!-- 기본 필드 -->
        <result property="chatSessionId" column="chat_session_id"/>
        <result property="senderRole"   column="sender_role" javaType="com.yachaerang.backend.api.common.SenderRole"
        typeHandler="com.yachaerang.backend.global.util.SenderRoleHandler"/>
        <result property="senderId"     column="sender_id"/>
        <result property="sentAt"       column="sent_at"/>
        <result property="content"      column="content"/>

        <!-- ChatSession JOIN 시 message 쪽 created/updated alias (msg_created_at / msg_updated_at) 사용 -->
        <result property="createdAt" column="msg_created_at"/>
        <result property="updatedAt" column="msg_updated_at"/>
    </resultMap>

    <!-- 단독 조회용 ResultMap (테이블에서 직접 조회할 때 사용) -->
    <resultMap id="ChatMessageSimpleResultMap"
               type="com.yachaerang.backend.api.chat.entity.ChatMessage">
        <id property="id" column="chat_message_id"/>
        <result property="chatSessionId" column="chat_session_id"/>
        <result property="senderRole"   column="sender_role"/>
        <result property="senderId"     column="sender_id"/>
        <result property="sentAt"       column="sent_at"/>
        <result property="content"      column="content"/>
        <result property="createdAt"    column="created_at"/>
        <result property="updatedAt"    column="updated_at"/>
    </resultMap>

    <!-- 공통 컬럼 (단독 조회/리스트 조회에서 사용) -->
    <sql id="chatMessageColumns">
        cm.chat_message_id,
        cm.chat_session_id,
        cm.sender_role,
        cm.sender_id,
        cm.sent_at,
        cm.content,
        cm.created_at,
        cm.updated_at
    </sql>

    <!-- INSERT -->
    <insert id="save"
            parameterType="com.yachaerang.backend.api.chat.entity.ChatMessage"
            useGeneratedKeys="true"
            keyProperty="id"
            keyColumn="chat_message_id">
        INSERT INTO chat_message (
            chat_session_id,
            sender_role,
            sender_id,
            sent_at,
            content,
            created_at,
            updated_at
        ) VALUES (
                     #{chatSessionId},
                     #{senderRole},
                     #{senderId},
                     #{sentAt},
                     #{content},
                     NOW(),
                     NOW()
                 )
    </insert>

    <!-- Batch INSERT -->
    <insert id="saveAll" parameterType="list">
        INSERT INTO chat_message (
        chat_session_id,
        sender_role,
        sender_id,
        sent_at,
        content,
        created_at,
        updated_at
        ) VALUES
        <foreach collection="list" item="message" separator=",">
            (
            #{message.chatSessionId},
            #{message.senderRole},
            #{message.senderId},
            #{message.sentAt},
            #{message.content},
            NOW(),
            NOW()
            )
        </foreach>
    </insert>

    <!-- SELECT by ID -->
    <select id="findById"
            parameterType="long"
            resultMap="ChatMessageSimpleResultMap">
        SELECT
        <include refid="chatMessageColumns"/>
        FROM chat_message cm
        WHERE cm.chat_message_id = #{id}
    </select>

    <!-- SELECT by sessionId (오름차순, limit 옵션) -->
    <select id="findAllByChatSessionIdOrderByCreatedAtAsc"
            resultMap="ChatMessageSimpleResultMap">
        SELECT
        <include refid="chatMessageColumns"/>
        FROM chat_message cm
        WHERE cm.chat_session_id = #{chatSessionId}
        ORDER BY cm.created_at ASC
        <if test="limit != null and limit > 0">
            LIMIT #{limit}
        </if>
    </select>

    <!-- SELECT recent messages (최근 N개를 가져온 뒤 다시 오름차순 정렬) -->
    <select id="findRecentMessagesByChatSessionId"
            resultMap="ChatMessageSimpleResultMap">
        SELECT *
        FROM (
        SELECT
        <include refid="chatMessageColumns"/>
        FROM chat_message cm
        WHERE cm.chat_session_id = #{chatSessionId}
        ORDER BY cm.created_at DESC
        LIMIT #{limit}
        ) AS recent
        ORDER BY recent.created_at ASC
    </select>

    <!-- COUNT by sessionId -->
    <select id="countByChatSessionId"
            parameterType="long"
            resultType="int">
        SELECT COUNT(*)
        FROM chat_message
        WHERE chat_session_id = #{chatSessionId}
    </select>

    <!-- SELECT by sessionId and senderRole -->
    <select id="findByChatSessionIdAndSenderRole"
            resultMap="ChatMessageSimpleResultMap">
        SELECT
        <include refid="chatMessageColumns"/>
        FROM chat_message cm
        WHERE cm.chat_session_id = #{chatSessionId}
        AND cm.sender_role = #{senderRole}
        ORDER BY cm.created_at ASC
    </select>

    <!-- DELETE by sessionId -->
    <delete id="deleteByChatSessionId" parameterType="long">
        DELETE FROM chat_message
        WHERE chat_session_id = #{chatSessionId}
    </delete>
</mapper>
