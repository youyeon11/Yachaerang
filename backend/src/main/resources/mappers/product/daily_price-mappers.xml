<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yachaerang.backend.api.product.repository.DailyPriceMapper">
    <resultMap id="dailyPriceResultMap"
               type="com.yachaerang.backend.api.product.entity.DailyPrice">
        <id property="dailyPriceId" column="daily_price_id"/>
        <result property="productCode" column="product_code"/>
        <result property="priceDate" column="price_date"/>
        <result property="price" column="price"/>
    </resultMap>
    <!-- PriceDto 매핑용 ResultMap -->
    <resultMap id="priceDtoResultMap"
               type="com.yachaerang.backend.api.product.dto.response.DailyPriceResponseDto$PriceRecordDto">
        <result property="priceDate" column="price_date" javaType="java.time.LocalDate"/>
        <result property="price" column="price" javaType="java.lang.Long"/>
    </resultMap>
    <!-- RankDto 매핑용 ResultMap -->
    <resultMap id="rankDtoResultMap"
               type="com.yachaerang.backend.api.product.dto.response.DailyPriceResponseDto$RankDto">
        <result property="productName" column="name" javaType="String"/>
        <result property="productCode" column="product_code" javaType="String"/>
        <result property="unit" column="unit" javaType="String"/>
        <result property="price" column="price" javaType="java.lang.Long"/>
    </resultMap>

    <!-- getPriceDuration -->
    <select id="getPriceDuration"
            resultMap="priceDtoResultMap">
        SELECT
            price_date,
            price
        FROM
            daily_price
        WHERE
            product_code = #{productCode}
          AND price_date <![CDATA[ >= ]]> #{startDate}
          AND price_date <![CDATA[ <= ]]> #{endDate}
        ORDER BY
            price_date ASC
    </select>

    <!-- getPricesDescending -->
    <select id="getPricesDescending" resultMap="rankDtoResultMap">
        SELECT
            name,
            product_code,
            unit,
            price
        FROM (
            SELECT
                p.name AS name,
                p.product_code as product_code,
                p.unit as unit,
                dp.price as price,
                dp.price_date as price_date
            FROM product p
            JOIN daily_price dp
                ON dp.product_code = p.product_code
        ) t
        WHERE t.price_date = #{priceDate}
        ORDER BY t.price DESC
        LIMIT 9
    </select>

    <!-- getPricesAscending-->
    <select id="getPricesAscending" resultMap="rankDtoResultMap">
        SELECT
            name,
            product_code,
            unit,
            price
        FROM (
                 SELECT
                     p.name AS name,
                     p.product_code as product_code,
                     p.unit as unit,
                     dp.price as price,
                     dp.price_date as price_date
                 FROM product p
                          JOIN daily_price dp
                               ON dp.product_code = p.product_code
             ) t
        WHERE t.price_date = #{priceDate}
        AND t.price != 0
        ORDER BY t.price ASC
        LIMIT 9
    </select>
</mapper>