<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yachaerang.backend.api.reaction.repository.ReactionMapper">
    <!-- Reaction ResultMap -->
    <resultMap id="reactionResultMap" type="com.yachaerang.backend.api.reaction.entity.Reaction">
        <id property="reactionId" column="reaction_id"/>
        <result property="memberId" column="member_id"/>
        <result property="articleId" column="article_id"/>
        <result property="reactionType" column="reaction_type"
                typeHandler="com.yachaerang.backend.global.util.ReactionTypeHandler"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <!-- MemberReaction ResultMap -->
    <resultMap id="memberReactionResultMap" type="com.yachaerang.backend.api.reaction.vo.MemberReaction">
        <id property="reactionId" column="reaction_id"/>
        <result property="memberId" column="member_id"/>
        <result property="articleId" column="article_id"/>
        <result property="reactionType" column="reaction_type"
                typeHandler="com.yachaerang.backend.global.util.ReactionTypeHandler"/>
        <association property="member" javaType="com.yachaerang.backend.api.member.entity.Member">
            <id property="id" column="member_id"/>
            <result property="nickname" column="nickname"/>
            <result property="imageUrl" column="image_url"/>
        </association>
    </resultMap>

    <!-- ReactionCount ResultMap -->
    <resultMap id="reactionCountResultMap" type="com.yachaerang.backend.api.reaction.dto.response.ReactionResponseDto$CountDto">
        <result property="reactionType" column="reaction_type"
                typeHandler="com.yachaerang.backend.global.util.ReactionTypeHandler"/>
        <result property="count" column="count"/>
    </resultMap>

    <!-- save -->
    <insert id="save" parameterType="com.yachaerang.backend.api.reaction.entity.Reaction"
            useGeneratedKeys="true" keyProperty="reactionId">
        INSERT INTO reactions (member_id, article_id, reaction_type, created_at, updated_at)
        VALUES (#{memberId}, #{articleId},
                #{reactionType},
                NOW(), NOW())
    </insert>

    <!-- findByMemberIdAndArticleIdAndReactionType -->
    <select id="findByMemberIdAndArticleIdAndReactionType" resultMap="reactionResultMap">
        SELECT reaction_id, member_id, article_id, reaction_type, created_at, updated_at
        FROM reactions
        WHERE member_id = #{memberId}
          AND article_id = #{articleId}
          AND reaction_type = #{reactionType}
    </select>

    <!-- delete -->
    <delete id="delete">
        DELETE FROM reactions
        WHERE member_id = #{memberId}
          AND article_id = #{articleId}
          AND reaction_type = #{reactionType}
    </delete>

    <!-- findMembersByArticleIdAndReactionType -->
    <select id="findMembersByArticleIdAndReactionType" resultMap="memberReactionResultMap">
        SELECT r.reaction_id, r.member_id, r.article_id, r.reaction_type,
               m.nickname, m.image_url
        FROM reactions r
                 INNER JOIN member m ON r.member_id = m.member_id
        WHERE r.article_id = #{articleId}
          AND r.reaction_type = #{reactionType}
        ORDER BY r.created_at DESC
    </select>

    <!-- countByArticleId -->
    <select id="countByArticleId" resultMap="reactionCountResultMap">
        SELECT reaction_type, COUNT(*) as count
        FROM reactions
        WHERE article_id = #{articleId}
        GROUP BY reaction_type
    </select>
</mapper>