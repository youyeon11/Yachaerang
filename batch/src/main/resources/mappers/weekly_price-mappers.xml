<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yachaerang.batch.repository.WeeklyPriceRepository">
    <resultMap id="weeklyPriceResultMap"
               type="com.yachaerang.batch.domain.entity.WeeklyPrice">
        <id property="weeklyPriceId" column="weekly_price_id"/>
        <result property="productCode" column="product_code"/>
        <result property="priceYear" column="price_year"/>
        <result property="weekNumber" column="week_number"/>
        <result property="startDate" column="start_date"/>
        <result property="endDate" column="end_date"/>
        <result property="minPrice" column="min_price"/>
        <result property="maxPrice" column="max_price"/>
        <result property="avgPrice" column="avg_price"/>
        <result property="priceCount" column="price_count"/>
        <result property="priceChange" column="price_change"/>
        <result property="priceChangeRate" column="price_change_rate"/>
    </resultMap>
    <!-- 일별 데이터를 주간으로 집계하여 조회 -->
    <select id="selectWeeklyAggregatedPrices" resultMap="weeklyPriceResultMap">
        SELECT
            agg.product_code  AS product_code,
            agg.price_year    AS price_year,
            agg.week_number   AS week_number,
            agg.start_date    AS start_date,
            agg.end_date      AS end_date,
            agg.avg_price     AS avg_price,
            agg.max_price     AS max_price,
            agg.min_price     AS min_price,
            agg.price_count   AS price_count
        FROM (
                 SELECT
                     dp.product_code AS product_code,
                     YEAR(dp.price_date) AS price_year,
                     WEEK(dp.price_date, 1) AS week_number,
                     #{startDate} AS start_date,
                     #{endDate} AS end_date,
                     ROUND(AVG(dp.price), 2) AS avg_price,
                     MAX(dp.price) AS max_price,
                     MIN(dp.price) AS min_price,
                     COUNT(*) AS price_count
                 FROM daily_price dp
                 WHERE dp.price_date BETWEEN #{startDate} AND #{endDate}
                 GROUP BY dp.product_code, YEAR(dp.price_date), WEEK(dp.price_date, 1)
             ) agg
        WHERE NOT EXISTS (
            SELECT 1
            FROM weekly_price wp
            WHERE wp.product_code = agg.product_code
              AND wp.price_year = agg.price_year
              AND wp.week_number = agg.week_number
        )
        ORDER BY agg.product_code, agg.price_year, agg.week_number
    </select>

    <!-- 주간 가격 데이터 저장 (UPSERT) -->
    <insert id="upsertWeeklyPrice" parameterType="com.yachaerang.batch.domain.entity.WeeklyPrice">
        INSERT INTO weekly_price (
            product_code, price_year, week_number,
            start_date, end_date,
            avg_price, max_price, min_price, price_count
        ) VALUES (
                     #{productCode}, #{priceYear}, #{weekNumber}, #{startDate}, #{endDate},
                     #{avgPrice}, #{maxPrice}, #{minPrice}, #{priceCount}
        ) ON DUPLICATE KEY UPDATE end_date = VALUES(end_date),
                                 avg_price = VALUES(avg_price),
                                 max_price = VALUES(max_price),
                                 min_price = VALUES(min_price),
                                 price_count = VALUES(price_count),
                                 updated_at = CURRENT_TIMESTAMP
    </insert>

    <!-- 배치 저장 -->
    <insert id="batchUpsertWeeklyPrice" parameterType="list">
        INSERT INTO weekly_price (
        product_code, price_year, week_number,
        start_date, end_date,
        avg_price, max_price, min_price, price_count, price_change, price_change_rate
        ) VALUES
        <foreach collection="list" item="item" separator=",">
            (
            #{item.productCode}, #{item.priceYear}, #{item.weekNumber},
            #{item.startDate}, #{item.endDate},
            #{item.avgPrice}, #{item.maxPrice}, #{item.minPrice}, #{item.priceCount}, #{item.priceChange}, #{item.priceChangeRate}
            )
        </foreach>
        ON DUPLICATE KEY UPDATE
        end_date = VALUES(end_date),
        avg_price = VALUES(avg_price),
        max_price = VALUES(max_price),
        min_price = VALUES(min_price),
        price_count = VALUES(price_count),
        price_change = VALUES(price_change),
        price_change_rate = VALUES(price_change_rate),
        updated_at = CURRENT_TIMESTAMP
    </insert>

</mapper>