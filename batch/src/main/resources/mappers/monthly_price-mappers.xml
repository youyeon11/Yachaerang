<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yachaerang.batch.repository.MonthlyPriceRepository">
    <resultMap id="monthlyPriceResultMap"
               type="com.yachaerang.batch.domain.entity.MonthlyPrice">
        <id property="monthlyPriceId" column="monthly_price_id"/>
        <result property="productCode" column="product_code"/>
        <result property="priceYear" column="price_year"/>
        <result property="priceMonth" column="price_month"/>
        <result property="avgPrice" column="avg_price"/>
        <result property="minPrice" column="min_price"/>
        <result property="maxPrice" column="max_price"/>
        <result property="priceCount" column="price_count"/>
        <result property="price" column="price"/>
        <result property="priceChange" column="price_change"/>
        <result property="priceChangeRate" column="price_change_rate"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>
    <!-- 일별 데이터를 월간으로 집계 -->
    <select id="selectMonthlyAggregatedPrices" resultMap="monthlyPriceResultMap">
        SELECT
            dp.product_code AS product_code,
            YEAR(dp.price_date) AS price_year,
            MONTH(dp.price_date) AS price_month,
            ROUND(AVG(dp.price), 2) AS avg_price,
            MIN(dp.price) AS min_price,
            MAX(dp.price) AS max_price,
            COUNT(*) AS price_count
        FROM daily_price dp
        WHERE dp.price_date BETWEEN #{startDate} AND #{endDate}
        GROUP BY dp.product_code, YEAR(dp.price_date), MONTH(dp.price_date)
        ORDER BY dp.product_code, price_year, price_month
    </select>

    <!-- 월별 가격 데이터 -->
    <insert id="upsertMonthlyPrice" parameterType="com.yachaerang.batch.domain.entity.MonthlyPrice">
        INSERT INTO monthly_price (
            product_code, price_year, price_month,
            avg_price, min_price, max_price, price_count
        ) VALUES (
                     #{productCode}, #{priceYear}, #{priceMonth},
                     #{avgPrice}, #{minPrice}, #{maxPrice}, #{priceCount},
                 )
            ON DUPLICATE KEY UPDATE avg_price = VALUES(avg_price),
                                    min_price = VALUES(min_price),
                                    max_price = VALUES(max_price),
                                    price_count = VALUES(price_count),
                                    updated_at = CURRENT_TIMESTAMP
    </insert>

    <!-- 배치 저장 -->
    <insert id="batchUpsertMonthlyPrice" parameterType="list">
        INSERT INTO monthly_price (
            product_code, price_year, price_month,
            avg_price, min_price, max_price, price_count, price_change, price_change_rate
        ) VALUES
            <foreach collection="list" item="item" separator=",">
                (
                #{item.productCode}, #{item.priceYear}, #{item.priceMonth},
                #{item.avgPrice}, #{item.minPrice}, #{item.maxPrice}, #{item.priceCount},
                 #{item.priceChange}, #{item.priceChangeRate}
                )
            </foreach>
        ON DUPLICATE KEY UPDATE
        avg_price = VALUES(avg_price),
        min_price = VALUES(min_price),
        max_price = VALUES(max_price),
        price_count = VALUES(price_count),
        price_change = VALUES(price_change),
        price_change_rate = VALUES(price_change_rate),
        updated_at = CURRENT_TIMESTAMP
    </insert>
</mapper>