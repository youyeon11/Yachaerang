<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yachaerang.batch.repository.YearlyPriceRepository">
    <resultMap id="yearlyPriceResultMap"
               type="com.yachaerang.batch.domain.entity.YearlyPrice">
        <id property="yearlyPriceId" column="yearly_price_id"/>
        <result property="productCode" column="product_code"/>
        <result property="priceYear" column="price_year"/>
        <result property="avgPrice" column="avg_price"/>
        <result property="minPrice" column="min_price"/>
        <result property="maxPrice" column="max_price"/>
        <result property="startPrice" column="start_price"/>
        <result property="endPrice" column="end_price"/>
        <result property="priceCount" column="price_count"/>
        <result property="priceChange" column="price_change"/>
        <result property="priceChangeRate" column="price_change_rate"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <!-- 일별 데이터를 연간으로 집계하여 조회 -->
    <select id="selectYearlyAggregatedPrices" resultMap="yearlyPriceResultMap">
        SELECT
            dp.product_code AS product_code,
            YEAR(dp.price_date) AS price_year,
            ROUND(AVG(dp.price), 2) AS avg_price,
            MIN(dp.price) AS min_price,
            MAX(dp.price) AS max_price,
            COUNT(*) AS price_count
        FROM daily_price dp
        WHERE YEAR(dp.price_date) = #{targetYear}
        GROUP BY dp.product_code, YEAR(dp.price_date)
        ORDER BY dp.product_code
    </select>

    <!-- 연초 가격 조회 (해당 연도 첫 번째 가격) -->
    <select id="selectStartPrice" resultType="java.lang.Long">
        SELECT dp.price
        FROM daily_price dp
        WHERE dp.product_code = #{productCode}
                  AND YEAR(dp.price_date) = #{targetYear}
        ORDER BY dp.price_date ASC
            LIMIT 1
    </select>

    <!-- 연말 가격 조회 (해당 연도 마지막 가격) -->
    <select id="selectEndPrice" resultType="java.lang.Long">
        SELECT dp.price
        FROM daily_price dp
        WHERE dp.product_code = #{productCode}
                  AND YEAR(dp.price_date) = #{targetYear}
        ORDER BY dp.price_date DESC
            LIMIT 1
    </select>

    <!-- 연간 가격 데이터 저장 (UPSERT) -->
    <insert id="upsertYearlyPrice" parameterType="com.yachaerang.batch.domain.entity.YearlyPrice">
        INSERT INTO yearly_price (
            product_code, price_year,
            avg_price, min_price, max_price,
            start_price, end_price, price_count,
                                  price_change, price_change_rate
        ) VALUES (
                  #{productCode}, #{priceYear}, #{avgPrice}, #{minPrice}, #{maxPrice},
                #{startPrice}, #{endPrice}, #{priceCount}, #{priceChange}, #{priceChangeRate})
        ON DUPLICATE KEY UPDATE avg_price = VALUES(avg_price),
                                min_price = VALUES(min_price),
                                max_price = VALUES(max_price),
                                start_price = VALUES(start_price),
                                end_price = VALUES(end_price),
                                price_count = VALUES(price_count),
                                price_change = VALUES(price_change),
                                price_change_rate = VALUES(price_change_rate),
                                updated_at = CURRENT_TIMESTAMP
    </insert>
</mapper>